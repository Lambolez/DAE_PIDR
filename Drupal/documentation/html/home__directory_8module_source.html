<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>DAEDrupalInterface: modules/home_directory/home_directory.module Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">DAEDrupalInterface
   &#160;<span id="projectnumber">1.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">modules/home_directory/home_directory.module</div>  </div>
</div><!--header-->
<div class="contents">
<a href="home__directory_8module.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment">// $Id:$</span>
<a name="l00003"></a>00003 
<a name="l00032"></a>00032 require_once(<span class="stringliteral">&quot;home_directory_uploads.var&quot;</span>);
<a name="l00033"></a>00033 
<a name="l00037"></a><a class="code" href="home__directory_8module.html#a08452a092f435fd2be0d2df5f5f21d74">00037</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a08452a092f435fd2be0d2df5f5f21d74">home_directory_menu</a>() 
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039   $items = array();
<a name="l00043"></a>00043   <span class="comment">/*</span>
<a name="l00044"></a>00044 <span class="comment">        $items[&#39;uploads&#39;] = array(</span>
<a name="l00045"></a>00045 <span class="comment">        &#39;title&#39; =&gt; &#39;My Uploads&#39;,</span>
<a name="l00046"></a>00046 <span class="comment">        &#39;page callback&#39; =&gt; &#39;home_directory_uploads&#39;,</span>
<a name="l00047"></a>00047 <span class="comment">        &#39;file&#39; =&gt; &#39;home_directory_uploads.inc&#39;,</span>
<a name="l00048"></a>00048 <span class="comment">        &#39;access arguments&#39; =&gt; array(&#39;access uploads&#39;),</span>
<a name="l00049"></a>00049 <span class="comment">        );</span>
<a name="l00050"></a>00050 <span class="comment">        $items[&#39;uploads/commit&#39;] = array(</span>
<a name="l00051"></a>00051 <span class="comment">        &#39;title&#39; =&gt; &#39;Commit Data&#39;,</span>
<a name="l00052"></a>00052 <span class="comment">        &#39;page callback&#39; =&gt; &#39;home_directory_commit&#39;,</span>
<a name="l00053"></a>00053 <span class="comment">        &#39;access arguments&#39; =&gt; array(&#39;commit data&#39;),</span>
<a name="l00054"></a>00054 <span class="comment">        );</span>
<a name="l00055"></a>00055 <span class="comment">        $items[&#39;uploads/batch&#39;] = array(</span>
<a name="l00056"></a>00056 <span class="comment">        &#39;title&#39; =&gt; &#39;Batch Operations&#39;,</span>
<a name="l00057"></a>00057 <span class="comment">        &#39;page callback&#39; =&gt; &#39;home_directory_run_batch&#39;,</span>
<a name="l00058"></a>00058 <span class="comment">        &#39;file&#39; =&gt; &#39;home_directory_batch.inc&#39;,</span>
<a name="l00059"></a>00059 <span class="comment">        &#39;access arguments&#39; =&gt; array(&#39;access uploads&#39;),</span>
<a name="l00060"></a>00060 <span class="comment">        &#39;type&#39; =&gt; &#39;MENU_CALLBACK&#39;</span>
<a name="l00061"></a>00061 <span class="comment">        );</span>
<a name="l00062"></a>00062 <span class="comment">        */</span>
<a name="l00063"></a>00063         $items[<span class="stringliteral">&#39;getThumb&#39;</span>] = array(
<a name="l00064"></a>00064         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Thumb&#39;</span>,
<a name="l00065"></a>00065         <span class="stringliteral">&#39;page callback&#39;</span> =&gt; <span class="stringliteral">&#39;home_directory_thumb&#39;</span>,
<a name="l00066"></a>00066         <span class="stringliteral">&#39;access arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;access uploads&#39;</span>),
<a name="l00067"></a>00067         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;MENU_CALLBACK&#39;</span>
<a name="l00068"></a>00068         );
<a name="l00069"></a>00069         $items[<span class="stringliteral">&#39;getFullSize&#39;</span>] = array(
<a name="l00070"></a>00070         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Thumb&#39;</span>,
<a name="l00071"></a>00071         <span class="stringliteral">&#39;page callback&#39;</span> =&gt; <span class="stringliteral">&#39;home_directory_fullsize&#39;</span>,
<a name="l00072"></a>00072         <span class="stringliteral">&#39;access arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;access uploads&#39;</span>),
<a name="l00073"></a>00073         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;MENU_CALLBACK&#39;</span>
<a name="l00074"></a>00074         );
<a name="l00075"></a>00075         $items[<span class="stringliteral">&#39;getFile&#39;</span>] = array(
<a name="l00076"></a>00076         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Download&#39;</span>,
<a name="l00077"></a>00077         <span class="stringliteral">&#39;page callback&#39;</span> =&gt; <span class="stringliteral">&#39;home_directory_download&#39;</span>,
<a name="l00078"></a>00078         <span class="stringliteral">&#39;access arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;access uploads&#39;</span>),
<a name="l00079"></a>00079         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;MENU_CALLBACK&#39;</span>
<a name="l00080"></a>00080         );
<a name="l00081"></a>00081         $items[<span class="stringliteral">&#39;admin/settings/home_directory&#39;</span>] = array (
<a name="l00082"></a>00082         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;DAE Home Directory Settings&#39;</span>,
<a name="l00083"></a>00083         <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Configure home directory settings.&#39;</span>,
<a name="l00084"></a>00084     <span class="stringliteral">&#39;access arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;administer site configuration&#39;</span>),
<a name="l00085"></a>00085     <span class="stringliteral">&#39;page callback&#39;</span> =&gt; <span class="stringliteral">&#39;drupal_get_form&#39;</span>,
<a name="l00086"></a>00086     <span class="stringliteral">&#39;page arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;home_directory_admin&#39;</span>),
<a name="l00087"></a>00087     <span class="stringliteral">&#39;file&#39;</span> =&gt; <span class="stringliteral">&#39;home_directory.admin.inc&#39;</span>,
<a name="l00088"></a>00088         );
<a name="l00089"></a>00089         $items[<span class="stringliteral">&#39;upload&#39;</span>] = array (
<a name="l00090"></a>00090         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Upload&#39;</span>,
<a name="l00091"></a>00091         <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Upload Data.&#39;</span>,
<a name="l00092"></a>00092     <span class="stringliteral">&#39;access arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;upload data&#39;</span>),
<a name="l00093"></a>00093     <span class="stringliteral">&#39;page callback&#39;</span> =&gt; <span class="stringliteral">&#39;drupal_get_form&#39;</span>,
<a name="l00094"></a>00094     <span class="stringliteral">&#39;page arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;home_directory_upload&#39;</span>),
<a name="l00095"></a>00095     <span class="stringliteral">&#39;file&#39;</span> =&gt; <span class="stringliteral">&#39;home_directory_upload_file.inc&#39;</span>,
<a name="l00096"></a>00096     <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;MENU_CALLBACK&#39;</span>
<a name="l00097"></a>00097         );
<a name="l00098"></a>00098         $items[<span class="stringliteral">&#39;upload/mkdir&#39;</span>] = array (
<a name="l00099"></a>00099         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Make Directory&#39;</span>,
<a name="l00100"></a>00100         <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Make a new directory&#39;</span>,
<a name="l00101"></a>00101     <span class="stringliteral">&#39;page callback&#39;</span> =&gt; <span class="stringliteral">&#39;drupal_get_form&#39;</span>,
<a name="l00102"></a>00102     <span class="stringliteral">&#39;page arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;home_directory_mkdir&#39;</span>),
<a name="l00103"></a>00103         <span class="stringliteral">&#39;access arguments&#39;</span> =&gt; array(<span class="stringliteral">&#39;upload data&#39;</span>),
<a name="l00104"></a>00104         <span class="stringliteral">&#39;file&#39;</span> =&gt; <span class="stringliteral">&#39;home_directory_mkdir.inc&#39;</span>,
<a name="l00105"></a>00105         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;MENU_CALLBACK&#39;</span>
<a name="l00106"></a>00106         );
<a name="l00107"></a>00107     <span class="keywordflow">return</span> $items;
<a name="l00108"></a>00108 }
<a name="l00112"></a><a class="code" href="home__directory_8module.html#ac64b81513ead7218d33df1e7c2eea0c3">00112</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#ac64b81513ead7218d33df1e7c2eea0c3">home_directory_perm</a>()
<a name="l00113"></a>00113 {
<a name="l00114"></a>00114         <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;access uploads&#39;</span>, <span class="stringliteral">&#39;access runs&#39;</span>, <span class="stringliteral">&#39;commit data&#39;</span>, <span class="stringliteral">&#39;upload data&#39;</span>, <span class="stringliteral">&#39;delete data&#39;</span>);
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00124"></a><a class="code" href="home__directory_8module.html#a90912bdf8d14c67c62282e19ff98515f">00124</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a90912bdf8d14c67c62282e19ff98515f">home_directory_user</a>($op, &amp;$edit, &amp;$account, $category = NULL)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126         $userDataDir = variable_get(<span class="stringliteral">&#39;home_directory_userdata&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00127"></a>00127         
<a name="l00128"></a>00128         require_once(<span class="stringliteral">&quot;./&quot;</span>.drupal_get_path(<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;daedatabase&#39;</span>).<span class="stringliteral">&quot;/daedatabase_db.inc&quot;</span>);
<a name="l00129"></a>00129         require_once(<span class="stringliteral">&quot;./&quot;</span>.drupal_get_path(<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;dae_data&#39;</span>).<span class="stringliteral">&quot;/dae_data_person.inc&quot;</span>);
<a name="l00130"></a>00130         <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a> = <a class="code" href="daedatabase__db_8inc.html#a87f09fb608629e6696b53ec65183dd2b" title="Get access to the current DAEDatabase instance.">getDAEDatabase</a>();
<a name="l00131"></a>00131         <span class="keywordflow">switch</span>($op){
<a name="l00132"></a>00132         <span class="keywordflow">case</span> <span class="stringliteral">&quot;update&quot;</span>:
<a name="l00133"></a>00133                 $pid=<a class="code" href="dae__data__person_8inc.html#ab3ef519b7351670783a88379a036cfd3">getPID</a>($account-&gt;uid);
<a name="l00134"></a>00134                 $variables[<span class="stringliteral">&#39;:profilename&#39;</span>] = <a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_name&#39;</span>);
<a name="l00135"></a>00135                 $variables[<span class="stringliteral">&#39;:pid&#39;</span>] = $pid;
<a name="l00136"></a>00136                 <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;q(<span class="stringliteral">&#39;update person set NAME=:profilename where ID=:pid&#39;</span>, $variables);
<a name="l00137"></a>00137                 
<a name="l00138"></a>00138                 <span class="comment">// \TODO </span>
<a name="l00139"></a>00139                 <span class="comment">// currently we assume users would not change one&#39;s email address to some email address already in Oracle but not in local Drupal</span>
<a name="l00140"></a>00140                 <span class="comment">// otherwise there will be inconsistency in database</span>
<a name="l00141"></a>00141                 
<a name="l00142"></a>00142                 <a class="code" href="home__directory_8module.html#ab59dd5b2d131675f65a3ac4c6dd4bc96">updatePersonInfo</a>(<span class="stringliteral">&quot;Email&quot;</span>,$pid,$account-&gt;mail);
<a name="l00143"></a>00143                 <a class="code" href="home__directory_8module.html#ab59dd5b2d131675f65a3ac4c6dd4bc96">updatePersonInfo</a>(<span class="stringliteral">&quot;Affiliation&quot;</span>,$pid,<a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_affiliation&#39;</span>));
<a name="l00144"></a>00144                 <a class="code" href="home__directory_8module.html#ab59dd5b2d131675f65a3ac4c6dd4bc96">updatePersonInfo</a>(<span class="stringliteral">&quot;Address&quot;</span>,$pid,<a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_address&#39;</span>));
<a name="l00145"></a>00145                 <a class="code" href="home__directory_8module.html#ab59dd5b2d131675f65a3ac4c6dd4bc96">updatePersonInfo</a>(<span class="stringliteral">&quot;Phone_Number&quot;</span>,$pid,<a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_phone&#39;</span>));
<a name="l00146"></a>00146                 <a class="code" href="home__directory_8module.html#ab59dd5b2d131675f65a3ac4c6dd4bc96">updatePersonInfo</a>(<span class="stringliteral">&quot;Research_Interest&quot;</span>,$pid,substr(<a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_interests&#39;</span>),0,100));
<a name="l00147"></a>00147                 <span class="keywordflow">break</span>;
<a name="l00148"></a>00148                 
<a name="l00149"></a>00149         <span class="keywordflow">case</span> <span class="stringliteral">&quot;insert&quot;</span>:
<a name="l00150"></a>00150                 mkdir($userDataDir.$account-&gt;uid);
<a name="l00151"></a>00151                 mkdir($userDataDir.$account-&gt;uid.<span class="stringliteral">&quot;/uploads&quot;</span>,0700);
<a name="l00152"></a>00152                 mkdir($userDataDir.$account-&gt;uid.<span class="stringliteral">&quot;/runs&quot;</span>,0700);
<a name="l00153"></a>00153                 update_sql(<span class="stringliteral">&quot;insert into {user_storage} values(&quot;</span>.$account-&gt;uid .<span class="stringliteral">&quot;,0)&quot;</span>);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155                 <span class="comment">// check email, if existing in Oracle, merge.</span>
<a name="l00156"></a>00156                 $bMerge=1;
<a name="l00157"></a>00157                 $pid=<a class="code" href="dae__data__person_8inc.html#a937cea0a154714729ab124a1b84252de">getPIDByEmail</a>($account-&gt;mail);
<a name="l00158"></a>00158                 <span class="comment">// otherwise get a new PID, insert to mysql</span>
<a name="l00159"></a>00159                 <span class="keywordflow">if</span>($pid==-1){
<a name="l00160"></a>00160                         $pid=<a class="code" href="dae__data__person_8inc.html#a791a164a35908c6e3e10a60c766033a6">getNextPID</a>();
<a name="l00161"></a>00161                         $bMerge=0;
<a name="l00162"></a>00162                 }
<a name="l00163"></a>00163                 $sql=<span class="stringliteral">&quot;insert into profile_values(fid,uid,value) select fid,&quot;</span>.$account-&gt;uid.<span class="stringliteral">&quot;,&#39;$pid&#39; from profile_fields where name=&#39;profile_person_id&#39;&quot;</span>;
<a name="l00164"></a>00164                 update_sql($sql);
<a name="l00165"></a>00165                 
<a name="l00166"></a>00166                 $variables[<span class="stringliteral">&#39;:profilename&#39;</span>] = <a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_name&#39;</span>);
<a name="l00167"></a>00167                 $variables[<span class="stringliteral">&#39;:pid&#39;</span>] = $pid;
<a name="l00168"></a>00168                 
<a name="l00169"></a>00169                 <span class="keywordflow">if</span>($bMerge==0){
<a name="l00170"></a>00170                         $sql=<span class="stringliteral">&#39;insert into Person(ID,NAME) values(:pid, :profilename)&#39;</span>;
<a name="l00171"></a>00171                 }<span class="keywordflow">else</span>{
<a name="l00172"></a>00172                         drupal_set_message(<span class="stringliteral">&#39;Your account is merged with the existing one&#39;</span>,<span class="stringliteral">&#39;warning&#39;</span>);
<a name="l00173"></a>00173                         $sql=<span class="stringliteral">&#39;update Person set NAME=:profilename where ID=:pid&#39;</span>;
<a name="l00174"></a>00174                 }
<a name="l00175"></a>00175                 
<a name="l00176"></a>00176                 <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;q($sql,$variables);
<a name="l00177"></a>00177                 
<a name="l00178"></a>00178                 <a class="code" href="home__directory_8module.html#ae90f261266029e5db068ab5e86e5d229">insertPersonInfo</a>(<span class="stringliteral">&quot;Email&quot;</span>,$pid,$account-&gt;mail,$account-&gt;uid,null);
<a name="l00179"></a>00179                 <a class="code" href="home__directory_8module.html#ae90f261266029e5db068ab5e86e5d229">insertPersonInfo</a>(<span class="stringliteral">&quot;Affiliation&quot;</span>,$pid,<a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_affiliation&#39;</span>),$account-&gt;uid,<span class="stringliteral">&#39;profile_affiliation&#39;</span>);
<a name="l00180"></a>00180                 <a class="code" href="home__directory_8module.html#ae90f261266029e5db068ab5e86e5d229">insertPersonInfo</a>(<span class="stringliteral">&quot;Address&quot;</span>,$pid,<a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_address&#39;</span>),$account-&gt;uid,<span class="stringliteral">&#39;profile_address&#39;</span>);
<a name="l00181"></a>00181                 <a class="code" href="home__directory_8module.html#ae90f261266029e5db068ab5e86e5d229">insertPersonInfo</a>(<span class="stringliteral">&quot;Phone_Number&quot;</span>,$pid,<a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_phone&#39;</span>),$account-&gt;uid,<span class="stringliteral">&#39;profile_phone&#39;</span>);
<a name="l00182"></a>00182                 <a class="code" href="home__directory_8module.html#ae90f261266029e5db068ab5e86e5d229">insertPersonInfo</a>(<span class="stringliteral">&quot;Research_Interest&quot;</span>,$pid,substr(<a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($account-&gt;uid,<span class="stringliteral">&#39;profile_interests&#39;</span>),0,100),$account-&gt;uid,<span class="stringliteral">&#39;profile_interests&#39;</span>);
<a name="l00183"></a>00183                 <span class="keywordflow">break</span>;
<a name="l00184"></a>00184                 
<a name="l00185"></a>00185         <span class="keywordflow">case</span> <span class="stringliteral">&quot;delete&quot;</span>:
<a name="l00186"></a>00186                 shell_exec(<span class="stringliteral">&quot;rm -r &quot;</span>.$userDataDir.$account-&gt;uid);
<a name="l00187"></a>00187                 <span class="keywordflow">break</span>;
<a name="l00188"></a>00188         }
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00198"></a><a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">00198</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a7825db7787b37d89a5ef23073a56ec61">getProfileValue</a>($uid,$profileField){
<a name="l00199"></a>00199         $sql=<span class="stringliteral">&quot;SELECT pv.value FROM profile_fields pf, profile_values pv WHERE pf.name = &#39;$profileField&#39; AND pf.fid = pv.fid AND pv.uid =$uid&quot;</span>;
<a name="l00200"></a>00200         <a class="code" href="services_2examples_2authenticated__service_2soap__server__test_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a> = db_result(db_query($sql));
<a name="l00201"></a>00201     <span class="keywordflow">return</span> <a class="code" href="services_2examples_2authenticated__service_2soap__server__test_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>;
<a name="l00202"></a>00202         
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00215"></a><a class="code" href="home__directory_8module.html#ae90f261266029e5db068ab5e86e5d229">00215</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#ae90f261266029e5db068ab5e86e5d229">insertPersonInfo</a>($tblStr,$pid,$val,$uid,$profile_field){
<a name="l00216"></a>00216         require_once(<span class="stringliteral">&quot;./&quot;</span>.drupal_get_path(<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;daedatabase&#39;</span>).<span class="stringliteral">&quot;/daedatabase_db.inc&quot;</span>);
<a name="l00217"></a>00217         <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a> = <a class="code" href="daedatabase__db_8inc.html#a87f09fb608629e6696b53ec65183dd2b" title="Get access to the current DAEDatabase instance.">getDAEDatabase</a>();
<a name="l00218"></a>00218         $colStr=strtoupper($tblStr);
<a name="l00219"></a>00219         <span class="keywordflow">if</span>($tblStr==<span class="stringliteral">&quot;Email&quot;</span>){
<a name="l00220"></a>00220                 $hasTblStr=<span class="stringliteral">&quot;has_More_Email&quot;</span>;
<a name="l00221"></a>00221         }<span class="keywordflow">else</span>{
<a name="l00222"></a>00222                 $hasTblStr=<span class="stringliteral">&quot;has_$tblStr&quot;</span>;
<a name="l00223"></a>00223         }
<a name="l00224"></a>00224         
<a name="l00225"></a>00225         <span class="keywordflow">if</span>(!empty($val)){
<a name="l00226"></a>00226             
<a name="l00227"></a>00227             $variables[<span class="stringliteral">&#39;:value&#39;</span>] = $val;
<a name="l00228"></a>00228                 $vid=<a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;r(<span class="stringliteral">&quot;select ID from $tblStr o where o.$colStr=:value&quot;</span>,$variables);
<a name="l00229"></a>00229                 <span class="keywordflow">if</span>(empty($vid)){
<a name="l00230"></a>00230                         $sql=<span class="stringliteral">&quot;insert into $tblStr($colStr) values(:value)&quot;</span>;
<a name="l00231"></a>00231                         <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;q($sql,$variables);
<a name="l00232"></a>00232                         $vid=<a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;r(<span class="stringliteral">&quot;select ID from $tblStr o where o.$colStr=:value&quot;</span>,$variables);
<a name="l00233"></a>00233                 }
<a name="l00234"></a>00234                 $sql=<span class="stringliteral">&quot;select PERSON_ID from $hasTblStr where PERSON_ID=$pid&quot;</span>;
<a name="l00235"></a>00235                 $rslt=<a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;r($sql,array());
<a name="l00236"></a>00236                 <span class="keywordflow">if</span>(empty($rslt)){
<a name="l00237"></a>00237                         $sql=<span class="stringliteral">&quot;insert into $hasTblStr(PERSON_ID,&quot;</span>.$colStr.<span class="stringliteral">&quot;_ID) values($pid,$vid)&quot;</span>;
<a name="l00238"></a>00238                 }<span class="keywordflow">else</span>{
<a name="l00239"></a>00239                         $sql=<span class="stringliteral">&quot;update $hasTblStr set &quot;</span>.$colStr.<span class="stringliteral">&quot;_ID=$vid where PERSON_ID=$pid&quot;</span>;
<a name="l00240"></a>00240                 }
<a name="l00241"></a>00241                 <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;q($sql,array());
<a name="l00242"></a>00242         }<span class="keywordflow">else</span>{
<a name="l00243"></a>00243                 <span class="keywordflow">if</span>($profile_field!=null){
<a name="l00244"></a>00244                         $sql=<span class="stringliteral">&quot;select $colStr from $hasTblStr h, $tblStr o where h.&quot;</span>.$colStr.<span class="stringliteral">&quot;_ID=o.ID and h.PERSON_ID=&quot;</span>.$pid;
<a name="l00245"></a>00245                         $val2=<a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;r($sql,array());
<a name="l00246"></a>00246                         <span class="keywordflow">if</span>(!empty($val2)){
<a name="l00247"></a>00247                                 $sql=<span class="stringliteral">&quot;insert into profile_values(fid,uid,value) select fid,$uid,&#39;$val2&#39; from profile_fields where name=&#39;$profile_field&#39;&quot;</span>;
<a name="l00248"></a>00248                                 update_sql($sql,array());
<a name="l00249"></a>00249                         }
<a name="l00250"></a>00250                 }
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00262"></a><a class="code" href="home__directory_8module.html#ab59dd5b2d131675f65a3ac4c6dd4bc96">00262</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#ab59dd5b2d131675f65a3ac4c6dd4bc96">updatePersonInfo</a>($tblStr,$pid,$val){
<a name="l00263"></a>00263         
<a name="l00264"></a>00264         <span class="comment">// \TODO email update issue</span>
<a name="l00265"></a>00265         require_once(<span class="stringliteral">&quot;./&quot;</span>.drupal_get_path(<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;daedatabase&#39;</span>).<span class="stringliteral">&quot;/daedatabase_db.inc&quot;</span>);
<a name="l00266"></a>00266         <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a> = <a class="code" href="daedatabase__db_8inc.html#a87f09fb608629e6696b53ec65183dd2b" title="Get access to the current DAEDatabase instance.">getDAEDatabase</a>();
<a name="l00267"></a>00267         $colStr=strtoupper($tblStr);
<a name="l00268"></a>00268         <span class="keywordflow">if</span>($tblStr==<span class="stringliteral">&quot;Email&quot;</span>){
<a name="l00269"></a>00269                 $hasTblStr=<span class="stringliteral">&quot;has_More_Email&quot;</span>;
<a name="l00270"></a>00270         }<span class="keywordflow">else</span>{
<a name="l00271"></a>00271                 $hasTblStr=<span class="stringliteral">&quot;has_$tblStr&quot;</span>;
<a name="l00272"></a>00272         }
<a name="l00273"></a>00273                 
<a name="l00274"></a>00274         <span class="keywordflow">if</span>(!empty($val)){
<a name="l00275"></a>00275             $variables[<span class="stringliteral">&#39;:value&#39;</span>] = $val;
<a name="l00276"></a>00276                 $sql=<span class="stringliteral">&quot;select ID from $tblStr o where o.$colStr=:value&quot;</span>;
<a name="l00277"></a>00277                 $vid=<a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;r($sql,$variables);
<a name="l00278"></a>00278                 <span class="keywordflow">if</span>(empty($vid)){
<a name="l00279"></a>00279                         $sql=<span class="stringliteral">&quot;insert into $tblStr($colStr) values(:value)&quot;</span>;
<a name="l00280"></a>00280                         <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;q($sql,$variables);
<a name="l00281"></a>00281                         $vid=<a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;r(<span class="stringliteral">&quot;select ID from $tblStr o where o.$colStr=:value&quot;</span>,$variables);
<a name="l00282"></a>00282                 }
<a name="l00283"></a>00283                 $sql=<span class="stringliteral">&quot;select PERSON_ID from $hasTblStr where PERSON_ID=$pid&quot;</span>;
<a name="l00284"></a>00284                 $rslt=<a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;r($sql,array());
<a name="l00285"></a>00285                 <span class="keywordflow">if</span>(empty($rslt)){
<a name="l00286"></a>00286                         $sql=<span class="stringliteral">&quot;insert into $hasTblStr(PERSON_ID,&quot;</span>.$colStr.<span class="stringliteral">&quot;_ID) values($pid,$vid)&quot;</span>;
<a name="l00287"></a>00287                 }<span class="keywordflow">else</span>{
<a name="l00288"></a>00288                         $sql=<span class="stringliteral">&quot;update $hasTblStr set &quot;</span>.$colStr.<span class="stringliteral">&quot;_ID=$vid where PERSON_ID=$pid&quot;</span>;
<a name="l00289"></a>00289                 }
<a name="l00290"></a>00290                 <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;q($sql,array());
<a name="l00291"></a>00291         }<span class="keywordflow">else</span>{
<a name="l00292"></a>00292                 $sql=<span class="stringliteral">&quot;delete from $hasTblStr where PERSON_ID=$pid&quot;</span>;
<a name="l00293"></a>00293                 <a class="code" href="algorithms__execute_8inc.html#a907d78797a1b764e913b0c565a5097b0">$db</a>-&gt;q($sql,array());
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00303"></a><a class="code" href="home__directory_8module.html#a47bb3aa153ad27edab881cf757d13284">00303</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a47bb3aa153ad27edab881cf757d13284" title="Returns a mimetype for a given file extension.">home_directory_content_type</a>($ext,$default = <span class="stringliteral">&quot;text/plain&quot;</span>)
<a name="l00304"></a>00304 {
<a name="l00310"></a>00310         <span class="keywordflow">switch</span>($ext)
<a name="l00311"></a>00311         {
<a name="l00312"></a>00312                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;png&quot;</span>: $content=<span class="stringliteral">&quot;image/png&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00313"></a>00313                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;jpeg&quot;</span>:
<a name="l00314"></a>00314                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;jpg&quot;</span>: $content=<span class="stringliteral">&quot;image/jpg&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00315"></a>00315                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;gif&quot;</span>: $content=<span class="stringliteral">&quot;image/gif&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00316"></a>00316                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;bmp&quot;</span>: $content=<span class="stringliteral">&quot;image/bmp&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00317"></a>00317                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;xml&quot;</span>: $content=<span class="stringliteral">&quot;txt/xml&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00318"></a>00318                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;txt&quot;</span>: $content=<span class="stringliteral">&quot;text/plain&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00319"></a>00319                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;pdf&quot;</span>: $content=<span class="stringliteral">&quot;application/pdf&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00320"></a>00320                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;pbm&quot;</span>: $content=<span class="stringliteral">&quot;image/x-portable-bitmap&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00321"></a>00321                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;tif&quot;</span>:
<a name="l00322"></a>00322                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;tiff&quot;</span>: $content=<span class="stringliteral">&quot;image/tiff&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00323"></a>00323                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;zip&quot;</span>: $content=<span class="stringliteral">&quot;application/zip&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00324"></a>00324                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;gz&quot;</span>:  $content=<span class="stringliteral">&quot;application/x-zip&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00325"></a>00325                                 
<a name="l00326"></a>00326                 <span class="keywordflow">default</span>: $content=$default;
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328         <span class="keywordflow">return</span> $type;
<a name="l00329"></a>00329 }
<a name="l00336"></a><a class="code" href="home__directory_8module.html#aa898882f0ca970434d100f8199d054ef">00336</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#aa898882f0ca970434d100f8199d054ef" title="Get file extension from a filename.">home_directory_get_filename_from_path</a>($file)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338         $file = explode(<span class="stringliteral">&quot;/&quot;</span>,$file);
<a name="l00339"></a>00339         end($file);
<a name="l00340"></a>00340         <span class="keywordflow">return</span> $file[key($file)];
<a name="l00341"></a>00341 }
<a name="l00348"></a><a class="code" href="home__directory_8module.html#ad33dc6210c48d4da819dc94f0d075aa0">00348</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#ad33dc6210c48d4da819dc94f0d075aa0" title="Get the path to a file from the full filepath.">home_directory_get_path_to_file_dir</a>($file)
<a name="l00349"></a>00349 {
<a name="l00350"></a>00350         $file = explode(<span class="stringliteral">&quot;/&quot;</span>,$file);
<a name="l00351"></a>00351         end($file);
<a name="l00352"></a>00352         unset($file[key($file)]);
<a name="l00353"></a>00353         $file = implode(<span class="stringliteral">&quot;/&quot;</span>,$file);
<a name="l00354"></a>00354         <span class="keywordflow">return</span> $file;
<a name="l00355"></a>00355 }
<a name="l00362"></a><a class="code" href="home__directory_8module.html#ade730a87caabad7af108bbe194a9422c">00362</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#ade730a87caabad7af108bbe194a9422c" title="Get file extension from a filename.">home_directory_get_file_extension</a>($file)
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364         $file = explode(<span class="stringliteral">&quot;.&quot;</span>,$file);
<a name="l00365"></a>00365         end($file);
<a name="l00366"></a>00366         <span class="keywordflow">return</span> $file[key($file)];
<a name="l00367"></a>00367 }
<a name="l00375"></a><a class="code" href="home__directory_8module.html#a0b73bbe6412ba1fbd4d12f8236eb7628">00375</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a0b73bbe6412ba1fbd4d12f8236eb7628" title="Checks that a file exists in $uploads.">home_directory_file_uploads_exists</a>($file)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377         global <a class="code" href="algorithms__run_8inc.html#ae7e10b5e4db0c9c2fef870aead26b979">$uploads</a>;
<a name="l00378"></a>00378         <span class="keywordflow">return</span> is_file($uploads.$file);
<a name="l00379"></a>00379 }
<a name="l00389"></a><a class="code" href="home__directory_8module.html#a6ec4b9cc0739923e6db35478ac5cb106">00389</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a6ec4b9cc0739923e6db35478ac5cb106" title="Gets a fullsize version of the image to display.">home_directory_fullsize</a>()
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391         <a class="code" href="home__directory_8module.html#ae9243142e53a6fd8a415f5b469539281" title="callback for getThumb">home_directory_thumb</a>();
<a name="l00392"></a>00392 }
<a name="l00402"></a><a class="code" href="home__directory_8module.html#ae9243142e53a6fd8a415f5b469539281">00402</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#ae9243142e53a6fd8a415f5b469539281" title="callback for getThumb">home_directory_thumb</a>()
<a name="l00403"></a>00403 {
<a name="l00404"></a>00404         global <a class="code" href="algorithms__run_8inc.html#ae7e10b5e4db0c9c2fef870aead26b979">$uploads</a>;
<a name="l00405"></a>00405         $loc = arg();
<a name="l00406"></a>00406         unset($loc[0]);
<a name="l00407"></a>00407         
<a name="l00408"></a>00408         $path = <span class="stringliteral">&quot;/&quot;</span>. implode(<span class="stringliteral">&quot;/&quot;</span>,$loc);
<a name="l00409"></a>00409         
<a name="l00410"></a>00410         <span class="keywordflow">if</span>(!file_exists($uploads . $path)){
<a name="l00411"></a>00411                 drupal_set_message(t(<span class="stringliteral">&#39;This file does not exist, or you do not have access.&#39;</span>),<span class="stringliteral">&#39;warning&#39;</span>);
<a name="l00412"></a>00412                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00413"></a>00413         }
<a name="l00414"></a>00414         <span class="keywordflow">else</span>
<a name="l00415"></a>00415         {
<a name="l00416"></a>00416                 end($loc);
<a name="l00417"></a>00417                 $ext = <a class="code" href="home__directory_8module.html#ade730a87caabad7af108bbe194a9422c" title="Get file extension from a filename.">home_directory_get_file_extension</a>($loc[key($loc)]);
<a name="l00418"></a>00418                 $isImage = <a class="code" href="home__directory_8module.html#af72931085591ba8994caa4aa60c0b4c7" title="Decides if a file extension is an image (for purpose of displaying thumb vs filetype icon)...">home_directory_check_image</a>($ext); 
<a name="l00419"></a>00419                 
<a name="l00420"></a>00420                 <span class="keywordflow">if</span>($isImage)
<a name="l00421"></a>00421                 {
<a name="l00422"></a>00422                         $content = <a class="code" href="home__directory_8module.html#a47bb3aa153ad27edab881cf757d13284" title="Returns a mimetype for a given file extension.">home_directory_content_type</a>($ext,<span class="stringliteral">&quot;image/jpeg&quot;</span>);
<a name="l00423"></a>00423                         header(<span class="stringliteral">&quot;content-type: $content&quot;</span>);
<a name="l00424"></a>00424                         readfile($uploads.$path);
<a name="l00425"></a>00425                 }
<a name="l00426"></a>00426                 <span class="keywordflow">else</span>
<a name="l00427"></a>00427                 {
<a name="l00428"></a>00428                         header(<span class="stringliteral">&quot;content-type: image/png&quot;</span>);
<a name="l00429"></a>00429                         <span class="keywordflow">if</span>(is_file(getcwd().<span class="charliteral">&#39;/&#39;</span>.drupal_get_path(<span class="stringliteral">&quot;module&quot;</span>,<span class="stringliteral">&quot;dae_ui&quot;</span>).<span class="stringliteral">&quot;/images/filetypes/file_&quot;</span>.$ext.<span class="stringliteral">&quot;.png&quot;</span>))
<a name="l00430"></a>00430                                 readfile(getcwd().<span class="charliteral">&#39;/&#39;</span>.drupal_get_path(<span class="stringliteral">&quot;module&quot;</span>,<span class="stringliteral">&quot;dae_ui&quot;</span>).<span class="stringliteral">&quot;/images/filetypes/file_&quot;</span>.$ext.<span class="stringliteral">&quot;.png&quot;</span>);
<a name="l00431"></a>00431                         <span class="keywordflow">else</span>
<a name="l00432"></a>00432                                 readfile(getcwd().<span class="charliteral">&#39;/&#39;</span>.drupal_get_path(<span class="stringliteral">&quot;module&quot;</span>,<span class="stringliteral">&quot;dae_ui&quot;</span>).<span class="stringliteral">&quot;/images/filetypes/file_&quot;</span>.$ext.<span class="stringliteral">&quot;.png&quot;</span>);
<a name="l00433"></a>00433                 }
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435 }
<a name="l00443"></a><a class="code" href="home__directory_8module.html#af72931085591ba8994caa4aa60c0b4c7">00443</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#af72931085591ba8994caa4aa60c0b4c7" title="Decides if a file extension is an image (for purpose of displaying thumb vs filetype icon)...">home_directory_check_image</a>($ext)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445         <span class="keywordflow">return</span> (preg_match(<span class="stringliteral">&quot;/$ext/i&quot;</span>,<span class="stringliteral">&quot;png jpg jpeg tif tiff bmp gif&quot;</span>));
<a name="l00446"></a>00446 }
<a name="l00455"></a><a class="code" href="home__directory_8module.html#ac8cfcce50bb478b259785b72dc2899f7">00455</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#ac8cfcce50bb478b259785b72dc2899f7" title="Callback for getFile.">home_directory_download</a>()
<a name="l00456"></a>00456 {
<a name="l00457"></a>00457         global <a class="code" href="algorithms__run_8inc.html#ae7e10b5e4db0c9c2fef870aead26b979">$uploads</a>, $runs, <a class="code" href="algorithms__run_8inc.html#a00365e6c5f70c43fb2ed86c9bc5626e0">$user</a>;
<a name="l00458"></a>00458         $loc = arg();
<a name="l00459"></a>00459         unset($loc[0]);
<a name="l00460"></a>00460         
<a name="l00461"></a>00461         <span class="keywordflow">switch</span>($loc[1])
<a name="l00462"></a>00462         {
<a name="l00463"></a>00463                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;uploads&quot;</span>: $from = <a class="code" href="algorithms__run_8inc.html#ae7e10b5e4db0c9c2fef870aead26b979">$uploads</a>; <span class="keywordflow">break</span>;
<a name="l00464"></a>00464                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;runs&quot;</span>: $from = $runs; <span class="keywordflow">break</span>;
<a name="l00465"></a>00465                 <span class="keywordflow">case</span> <span class="stringliteral">&quot;tmp&quot;</span>: $from = <span class="stringliteral">&quot;/dae/spool/&quot;</span> . $user-&gt;uid . <span class="stringliteral">&quot;/&quot;</span>; $tmp = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
<a name="l00466"></a>00466                 <span class="keywordflow">default</span>: $from = $runs; <span class="keywordflow">break</span>;
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468         unset($loc[1]);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470         <span class="keywordflow">if</span>(!$tmp)
<a name="l00471"></a>00471                 $path = <span class="stringliteral">&quot;/&quot;</span>.implode(<span class="stringliteral">&quot;/&quot;</span>,$loc);
<a name="l00472"></a>00472         <span class="keywordflow">else</span>
<a name="l00473"></a>00473                 $path = $loc[2];
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         <span class="keywordflow">if</span>(!file_exists($from . $path)){
<a name="l00476"></a>00476                 drupal_set_message(t(<span class="stringliteral">&#39;This file does not exist, or you do not have access.&#39;</span>),<span class="stringliteral">&#39;warning&#39;</span>);
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478         <span class="keywordflow">else</span>
<a name="l00479"></a>00479         {
<a name="l00480"></a>00480                 end($loc);
<a name="l00481"></a>00481                 header(<span class="stringliteral">&#39;Content-Disposition: attachment; filename=&#39;</span>. $loc[key($loc)]);
<a name="l00482"></a>00482                 $ext = <a class="code" href="home__directory_8module.html#ade730a87caabad7af108bbe194a9422c" title="Get file extension from a filename.">home_directory_get_file_extension</a>($loc[key($loc)]);
<a name="l00483"></a>00483                 $content = <a class="code" href="home__directory_8module.html#a47bb3aa153ad27edab881cf757d13284" title="Returns a mimetype for a given file extension.">home_directory_content_type</a>($ext,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00484"></a>00484                 header(<span class="stringliteral">&quot;content-type: $content&quot;</span>);
<a name="l00485"></a>00485                 $size = filesize($from.$path);
<a name="l00486"></a>00486                 header(<span class="stringliteral">&quot;Content-Length: &quot;</span>.$size);
<a name="l00487"></a>00487                 
<a name="l00488"></a>00488             set_time_limit(300);
<a name="l00489"></a>00489         <span class="comment">// If it&#39;s a large file, readfile might not be able to do it in one go, so:</span>
<a name="l00490"></a>00490         $chunksize = 10 * (1024 * 1024); <span class="comment">// how many bytes per chunk</span>
<a name="l00491"></a>00491         <span class="keywordflow">if</span> ($size &gt; $chunksize) {
<a name="l00492"></a>00492           $handle = fopen($from.$path, <span class="stringliteral">&#39;rb&#39;</span>);
<a name="l00493"></a>00493           $buffer = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00494"></a>00494           <span class="keywordflow">while</span> (!feof($handle)) {
<a name="l00495"></a>00495             $buffer = fread($handle, $chunksize);
<a name="l00496"></a>00496             echo $buffer;
<a name="l00497"></a>00497             ob_flush();
<a name="l00498"></a>00498             flush();
<a name="l00499"></a>00499           }
<a name="l00500"></a>00500           fclose($handle);
<a name="l00501"></a>00501         } <span class="keywordflow">else</span> {
<a name="l00502"></a>00502           readfile($from.$path);
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00507"></a>00507 }
<a name="l00515"></a><a class="code" href="home__directory_8module.html#aa073919b993d36249c735aea3118d974">00515</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#aa073919b993d36249c735aea3118d974" title="Deletes a file in the user&#39;s uploads folder and updates user&#39;s usage.">home_directory_remove_file</a>($file)
<a name="l00516"></a>00516 {
<a name="l00517"></a>00517         global <a class="code" href="algorithms__run_8inc.html#ae7e10b5e4db0c9c2fef870aead26b979">$uploads</a>;
<a name="l00518"></a>00518         
<a name="l00519"></a>00519         <span class="keywordflow">if</span>(file_exists($uploads . $file)):
<a name="l00520"></a>00520                 <a class="code" href="home__directory_8module.html#a0f7693cc026808232fa5eda1d7d7f586" title="Updates the current user&#39;s file storage amount.">home_directory_change_usage</a>(-(filesize($uploads . $file)));
<a name="l00521"></a>00521                 unlink($uploads . $file);
<a name="l00522"></a>00522         <span class="keywordflow">else</span>:
<a name="l00523"></a>00523                 watchdog(<span class="stringliteral">&quot;File Does Not Exists&quot;</span>,t(<span class="stringliteral">&quot;There was a failed attempt to delete \&quot;%file\&quot;.&quot;</span>,array(<span class="stringliteral">&quot;%file&quot;</span> =&gt; $file)),array(),WATCHDOG_ERROR);
<a name="l00524"></a>00524         endif;
<a name="l00525"></a>00525 }
<a name="l00534"></a><a class="code" href="home__directory_8module.html#ab34f4148673cb01b8f0ed5ed3a0cb7e1">00534</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#ab34f4148673cb01b8f0ed5ed3a0cb7e1" title="Deletes a directory and the files inside while updating user storage.">home_directory_remove_directory</a>($dir,$subdir = <span class="stringliteral">&quot;&quot;</span>)
<a name="l00535"></a>00535 {
<a name="l00536"></a>00536         global <a class="code" href="algorithms__run_8inc.html#ae7e10b5e4db0c9c2fef870aead26b979">$uploads</a>;
<a name="l00537"></a>00537         
<a name="l00538"></a>00538         <span class="keywordflow">if</span>(is_dir($uploads .<span class="charliteral">&#39;/&#39;</span>. $dir))
<a name="l00539"></a>00539         {
<a name="l00540"></a>00540         
<a name="l00541"></a>00541                 $uploadsDir = $uploads . $dir .<span class="charliteral">&#39;/&#39;</span> . $subdir;
<a name="l00542"></a>00542                 
<a name="l00543"></a>00543                 $files = <a class="code" href="home__directory_8module.html#a1e4c19342271d6ee1be5aa4d1c05f106" title="Get a list of files in the given directory without . and ..">hd_scandir</a>($uploadsDir);
<a name="l00544"></a>00544                 
<a name="l00545"></a>00545                 <span class="keywordflow">foreach</span>($files as $file):
<a name="l00546"></a>00546                 
<a name="l00547"></a>00547                         <span class="keywordflow">if</span>(is_dir($uploadsDir . <span class="charliteral">&#39;/&#39;</span> . $file))
<a name="l00548"></a>00548                                 <a class="code" href="home__directory_8module.html#ab34f4148673cb01b8f0ed5ed3a0cb7e1" title="Deletes a directory and the files inside while updating user storage.">home_directory_remove_directory</a>($dir,$subdir.$file.<span class="charliteral">&#39;/&#39;</span>);
<a name="l00549"></a>00549                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(is_file($uploadsDir . <span class="charliteral">&#39;/&#39;</span> . $file))
<a name="l00550"></a>00550                                  <a class="code" href="home__directory_8module.html#aa073919b993d36249c735aea3118d974" title="Deletes a file in the user&#39;s uploads folder and updates user&#39;s usage.">home_directory_remove_file</a>($dir .<span class="charliteral">&#39;/&#39;</span> . $subdir . $file);
<a name="l00551"></a>00551                         
<a name="l00552"></a>00552                 endforeach;
<a name="l00553"></a>00553                 rmdir($uploadsDir);
<a name="l00554"></a>00554         }       
<a name="l00555"></a>00555         
<a name="l00556"></a>00556 }
<a name="l00564"></a><a class="code" href="home__directory_8module.html#a1e4c19342271d6ee1be5aa4d1c05f106">00564</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a1e4c19342271d6ee1be5aa4d1c05f106" title="Get a list of files in the given directory without . and ..">hd_scandir</a>($dir)
<a name="l00565"></a>00565 {
<a name="l00566"></a>00566         <span class="keywordflow">if</span>(file_exists($dir)):
<a name="l00567"></a>00567                 
<a name="l00568"></a>00568                 $files = scandir($dir);
<a name="l00569"></a>00569                 <span class="keywordflow">foreach</span>($files as $key =&gt; $file):
<a name="l00570"></a>00570                 
<a name="l00571"></a>00571                         <span class="keywordflow">if</span>($file == <span class="stringliteral">&quot;..&quot;</span> || $file == <span class="stringliteral">&quot;.&quot;</span>)
<a name="l00572"></a>00572                                 unset($files[$key]);
<a name="l00573"></a>00573                 
<a name="l00574"></a>00574                 endforeach;
<a name="l00575"></a>00575                 <span class="keywordflow">return</span> $files;
<a name="l00576"></a>00576                 
<a name="l00577"></a>00577         <span class="keywordflow">else</span>:
<a name="l00578"></a>00578                 watchdog(<span class="stringliteral">&quot;Directory Not Found&quot;</span>,t(<span class="stringliteral">&quot;There was a failed attempt to access \&quot;%dir\&quot;.&quot;</span>,array(<span class="stringliteral">&quot;%dir&quot;</span> =&gt; $dir)),array(),WATCHDOG_ERROR);
<a name="l00579"></a>00579                 <span class="keywordflow">return</span> array();
<a name="l00580"></a>00580         endif;
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 
<a name="l00583"></a><a class="code" href="home__directory_8module.html#a4313ac284cc38dd16b5015c66911cf80">00583</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a4313ac284cc38dd16b5015c66911cf80">home_directory_commit</a>()
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585         <span class="keywordflow">return</span> <span class="stringliteral">&quot;Under Construction&quot;</span>;
<a name="l00586"></a>00586 }
<a name="l00599"></a><a class="code" href="home__directory_8module.html#a85ef8aef539cc1f8f2211903ed4b78cb">00599</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a85ef8aef539cc1f8f2211903ed4b78cb" title="Takes a user&#39;s input for a directory name and sanitizes/avoids name conflicts.">home_directory_make_directory</a>($dir,$fullPathtoDir,$recurse = <span class="keyword">false</span>)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601         $dirName = preg_replace(<span class="stringliteral">&quot;/[^a-zA-Z0-9]/&quot;</span>,<span class="stringliteral">&quot;_&quot;</span>,$dir);
<a name="l00602"></a>00602         $dirName = <a class="code" href="home__directory_8module.html#a9bcd4d6f7ff45046f618e7a1b3e90d78" title="Used when creating directories to get a new name if the directory exists.">home_directory_dir_rename</a>($fullPathtoDir,$dirName);
<a name="l00603"></a>00603                 
<a name="l00604"></a>00604         <span class="keywordflow">if</span>(mkdir($fullPathtoDir.$dirName))
<a name="l00605"></a>00605                 <span class="keywordflow">return</span> $dirName;
<a name="l00606"></a>00606         <span class="keywordflow">else</span>
<a name="l00607"></a>00607                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00608"></a>00608 }
<a name="l00619"></a><a class="code" href="home__directory_8module.html#a085140c32c4aa47cd6217b6bfd9c4a84">00619</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a085140c32c4aa47cd6217b6bfd9c4a84" title="Renames files if the file already exists.">home_directory_upload_rename</a>($path,$filename)
<a name="l00620"></a>00620 {
<a name="l00621"></a>00621         $filenameParts = explode(<span class="charliteral">&#39;.&#39;</span>,$filename);
<a name="l00622"></a>00622         $num = 1;
<a name="l00623"></a>00623         <span class="keywordflow">while</span>(is_file($path.$filename)):
<a name="l00624"></a>00624                 $filename = $filenameParts[0] . <span class="stringliteral">&quot;_&quot;</span> . $num . <span class="stringliteral">&quot;.&quot;</span> . $filenameParts[1];
<a name="l00625"></a>00625                 $num++;
<a name="l00626"></a>00626         endwhile;
<a name="l00627"></a>00627         
<a name="l00628"></a>00628         <span class="keywordflow">return</span> $filename;
<a name="l00629"></a>00629 }
<a name="l00640"></a><a class="code" href="home__directory_8module.html#a9bcd4d6f7ff45046f618e7a1b3e90d78">00640</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a9bcd4d6f7ff45046f618e7a1b3e90d78" title="Used when creating directories to get a new name if the directory exists.">home_directory_dir_rename</a>($path,$dirName)
<a name="l00641"></a>00641 {
<a name="l00642"></a>00642         $num = 1;
<a name="l00643"></a>00643         $try = $dirName;
<a name="l00644"></a>00644         <span class="keywordflow">while</span>(file_exists($path.$try)):
<a name="l00645"></a>00645                 $try = $dirName . <span class="stringliteral">&quot;_&quot;</span> . $num;
<a name="l00646"></a>00646                 $num++;
<a name="l00647"></a>00647         endwhile;
<a name="l00648"></a>00648         
<a name="l00649"></a>00649         <span class="keywordflow">return</span> $try;
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00659"></a><a class="code" href="home__directory_8module.html#a0f7693cc026808232fa5eda1d7d7f586">00659</a> <span class="keyword">function</span> <a class="code" href="home__directory_8module.html#a0f7693cc026808232fa5eda1d7d7f586" title="Updates the current user&#39;s file storage amount.">home_directory_change_usage</a>($amount)
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661         global <a class="code" href="algorithms__run_8inc.html#a00365e6c5f70c43fb2ed86c9bc5626e0">$user</a>;
<a name="l00662"></a>00662         <span class="keywordflow">if</span>($amount &lt; 0)
<a name="l00663"></a>00663         {
<a name="l00664"></a>00664                 $r = db_query(<span class="stringliteral">&quot;select used from {user_storage} where uid = &quot;</span>.$user-&gt;uid);
<a name="l00665"></a>00665                 $row = db_fetch_array($r);
<a name="l00666"></a>00666                 <span class="keywordflow">if</span>($amount*-1 &gt; $row[<span class="stringliteral">&#39;used&#39;</span>])
<a name="l00667"></a>00667                         $amount = $row[<span class="stringliteral">&#39;used&#39;</span>]*-1;
<a name="l00668"></a>00668         }
<a name="l00669"></a>00669         update_sql(<span class="stringliteral">&quot;update {user_storage} set used = used+&quot;</span>. $amount .<span class="stringliteral">&quot; where uid = &quot;</span>.$user-&gt;uid);
<a name="l00670"></a>00670 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 9 2012 10:33:42 for DAEDrupalInterface by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.0
</small></address>

</body>
</html>
